name: Build arm64 static from source
on: workflow_dispatch
jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build tools
        run: |
          brew install cmake ninja
      
      - name: Build abseil static
        run: |
          cd $HOME
          git clone --depth 1 --branch 20240116.2 https://github.com/abseil/abseil-cpp.git
          cd abseil-cpp
          mkdir build && cd build
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DABSL_BUILD_TESTING=OFF \
            -DABSL_USE_GOOGLETEST_HEAD=OFF \
            -DCMAKE_INSTALL_PREFIX=$HOME/local \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
          ninja
          ninja install
          
          echo "=== Abseil static libs ==="
          ls $HOME/local/lib/*.a | head -20
      
      - name: Build protobuf static
        run: |
          cd $HOME
          git clone --depth 1 --branch v25.3 https://github.com/protocolbuffers/protobuf.git
          cd protobuf
          mkdir build && cd build
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -Dprotobuf_BUILD_TESTS=OFF \
            -Dprotobuf_ABSL_PROVIDER=package \
            -DCMAKE_PREFIX_PATH=$HOME/local \
            -DCMAKE_INSTALL_PREFIX=$HOME/local \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
          ninja
          ninja install
          
          echo "=== Protobuf static libs ==="
          ls $HOME/local/lib/*.a | head -20
      
      - name: Compile grpc-java plugin
        run: |
          cd compiler/src/java_plugin/cpp
          
          # Compile
          clang++ -std=c++17 -mmacosx-version-min=10.15 \
            -I$HOME/local/include \
            -c java_generator.cpp -o java_generator.o
          
          clang++ -std=c++17 -mmacosx-version-min=10.15 \
            -I$HOME/local/include \
            -c java_plugin.cpp -o java_plugin.o
          
          # Get list of all static libs needed
          echo "=== All static libs ==="
          ls $HOME/local/lib/*.a
          
          # Link everything statically
          clang++ -mmacosx-version-min=10.15 \
            java_generator.o java_plugin.o \
            $HOME/local/lib/libprotoc.a \
            $HOME/local/lib/libprotobuf.a \
            $HOME/local/lib/libutf8_validity.a \
            $HOME/local/lib/libabsl_*.a \
            -lc++ \
            -framework CoreFoundation \
            -o protoc-gen-grpc-java
          
          echo "=== Checking dependencies ==="
          otool -L protoc-gen-grpc-java
          
          echo "=== File info ==="
          file protoc-gen-grpc-java
          ls -lh protoc-gen-grpc-java
          
          echo "=== Test run ==="
          ./protoc-gen-grpc-java --version || echo "Done"
          
          mkdir -p $GITHUB_WORKSPACE/output
          cp protoc-gen-grpc-java $GITHUB_WORKSPACE/output/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: protoc-gen-grpc-java-arm64-static
          path: output/protoc-gen-grpc-java
