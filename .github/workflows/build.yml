name: Build arm64 manual
on: workflow_dispatch
jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew install protobuf abseil
      
      - name: Manual compile
        run: |
          PROTOBUF_PREFIX=$(brew --prefix protobuf)
          ABSEIL_PREFIX=$(brew --prefix abseil)
          
          # Get all abseil dylibs for linking
          ABSEIL_LIBS=$(pkg-config --libs absl_log absl_log_internal_message absl_log_internal_check_op absl_strings absl_hash absl_raw_hash_set absl_synchronization absl_base absl_time absl_int128 2>/dev/null || echo "-L${ABSEIL_PREFIX}/lib -labsl_log_internal_message -labsl_log_internal_check_op -labsl_strings -labsl_hash -labsl_raw_hash_set -labsl_synchronization -labsl_base -labsl_time -labsl_int128 -labsl_raw_logging_internal -labsl_throw_delegate -labsl_string_view -labsl_strings_internal -labsl_spinlock_wait -labsl_city -labsl_low_level_hash -labsl_debugging_internal -labsl_demangle_internal -labsl_stacktrace -labsl_symbolize -labsl_time_zone -labsl_log_severity -labsl_examine_stack -labsl_log_globals -labsl_log_internal_conditions -labsl_log_internal_format -labsl_log_internal_nullguard -labsl_strerror -labsl_log_sink -labsl_hashtablez_sampler -labsl_malloc_internal -labsl_vlog_config_internal")
          
          echo "Abseil libs: $ABSEIL_LIBS"
          
          cd compiler/src/java_plugin/cpp
          
          # Compile each file
          clang++ -std=c++17 -mmacosx-version-min=10.15 \
            -I${PROTOBUF_PREFIX}/include \
            -I${ABSEIL_PREFIX}/include \
            -c java_generator.cpp -o java_generator.o
          
          clang++ -std=c++17 -mmacosx-version-min=10.15 \
            -I${PROTOBUF_PREFIX}/include \
            -I${ABSEIL_PREFIX}/include \
            -c java_plugin.cpp -o java_plugin.o
          
          # Link
          clang++ -mmacosx-version-min=10.15 \
            java_generator.o java_plugin.o \
            -L${PROTOBUF_PREFIX}/lib \
            -L${ABSEIL_PREFIX}/lib \
            -lprotoc -lprotobuf \
            $ABSEIL_LIBS \
            -o protoc-gen-grpc-java
          
          # Verify
          file protoc-gen-grpc-java
          ./protoc-gen-grpc-java --version || true
          
          # Copy to expected location
          mkdir -p $GITHUB_WORKSPACE/output
          cp protoc-gen-grpc-java $GITHUB_WORKSPACE/output/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: protoc-gen-grpc-java-arm64
          path: output/protoc-gen-grpc-java
