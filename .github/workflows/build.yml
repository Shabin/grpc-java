name: Build arm64 static
on: workflow_dispatch
jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew install protobuf abseil
      
      - name: Manual compile with static linking
        run: |
          PROTOBUF_PREFIX=$(brew --prefix protobuf)
          ABSEIL_PREFIX=$(brew --prefix abseil)
          
          cd compiler/src/java_plugin/cpp
          
          # Compile each file
          clang++ -std=c++17 -mmacosx-version-min=10.15 \
            -I${PROTOBUF_PREFIX}/include \
            -I${ABSEIL_PREFIX}/include \
            -c java_generator.cpp -o java_generator.o
          
          clang++ -std=c++17 -mmacosx-version-min=10.15 \
            -I${PROTOBUF_PREFIX}/include \
            -I${ABSEIL_PREFIX}/include \
            -c java_plugin.cpp -o java_plugin.o
          
          # Find all static libraries (.a files)
          echo "=== Finding static libs ==="
          find ${PROTOBUF_PREFIX}/lib -name "*.a" | head -10
          find ${ABSEIL_PREFIX}/lib -name "*.a" | head -10
          
          # Link statically using .a files directly
          clang++ -mmacosx-version-min=10.15 \
            java_generator.o java_plugin.o \
            ${PROTOBUF_PREFIX}/lib/libprotoc.a \
            ${PROTOBUF_PREFIX}/lib/libprotobuf.a \
            ${ABSEIL_PREFIX}/lib/libabsl_*.a \
            -lc++ \
            -framework CoreFoundation \
            -o protoc-gen-grpc-java
          
          # Verify it's not depending on homebrew libs
          echo "=== Checking dependencies ==="
          otool -L protoc-gen-grpc-java
          
          file protoc-gen-grpc-java
          
          mkdir -p $GITHUB_WORKSPACE/output
          cp protoc-gen-grpc-java $GITHUB_WORKSPACE/output/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: protoc-gen-grpc-java-arm64-static
          path: output/protoc-gen-grpc-java
